#!/usr/bin/env bash
#
# Pre-push hook that mirrors CI checks
#
# This hook runs the same checks as GitHub Actions CI to catch issues locally
# before they reach the remote repository.
#
# Checks performed:
# 1. RuboCop (linting)
# 2. RSpec (tests)
# 3. Gem build (validates gemspec)
#
# To skip these checks (not recommended), use: git push --no-verify
#

set -e  # Exit on first error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Symbols
CHECKMARK="✓"
CROSS="✗"
ARROW="→"

echo ""
echo -e "${BLUE}===========================================${NC}"
echo -e "${BLUE}  Pre-Push Checks (Mirroring CI)${NC}"
echo -e "${BLUE}===========================================${NC}"
echo ""

# Track overall success
ALL_CHECKS_PASSED=true

# Function to print section header
print_section() {
  echo -e "${BLUE}${ARROW} $1${NC}"
}

# Function to print success
print_success() {
  echo -e "${GREEN}  ${CHECKMARK} $1${NC}"
}

# Function to print error
print_error() {
  echo -e "${RED}  ${CROSS} $1${NC}"
}

# Function to print warning
print_warning() {
  echo -e "${YELLOW}  ⚠ $1${NC}"
}

#############################################
# Check 1: RuboCop (Linting)
#############################################
print_section "Running RuboCop..."

if bundle exec rubocop; then
  print_success "RuboCop passed (no offenses)"
else
  print_error "RuboCop failed (see offenses above)"
  print_warning "Run 'bundle exec rubocop --autocorrect' to fix auto-correctable issues"
  ALL_CHECKS_PASSED=false
fi

echo ""

#############################################
# Check 2: RSpec (Tests)
#############################################
print_section "Running RSpec tests..."

if bundle exec rspec; then
  print_success "RSpec passed (all tests passing)"
else
  print_error "RSpec failed (see failures above)"
  print_warning "Fix failing tests before pushing"
  ALL_CHECKS_PASSED=false
fi

echo ""

#############################################
# Check 3: Gem Build (Validates gemspec)
#############################################
print_section "Building gem (validates gemspec)..."

# Create pkg directory if it doesn't exist
mkdir -p pkg

# Clean old gem files
rm -f pkg/vagrant-orbstack-*.gem

if gem build vagrant-orbstack.gemspec && mv vagrant-orbstack-*.gem pkg/; then
  print_success "Gem built successfully"

  # Show what files are included in the gem
  echo ""
  echo -e "${BLUE}  Files included in gem:${NC}"
  gem spec pkg/vagrant-orbstack-*.gem files | grep -E '\.(rb|yml)$' | head -n 10
  file_count=$(gem spec pkg/vagrant-orbstack-*.gem files | grep -E '\.(rb|yml)$' | wc -l | tr -d ' ')
  echo -e "${BLUE}  ... and $((file_count - 10)) more files${NC}"
else
  print_error "Gem build failed (gemspec validation error)"
  ALL_CHECKS_PASSED=false
fi

echo ""

#############################################
# Summary
#############################################
echo -e "${BLUE}===========================================${NC}"
if [ "$ALL_CHECKS_PASSED" = true ]; then
  echo -e "${GREEN}  All pre-push checks passed! ${CHECKMARK}${NC}"
  echo -e "${GREEN}  Safe to push to remote.${NC}"
  echo -e "${BLUE}===========================================${NC}"
  echo ""
  exit 0
else
  echo -e "${RED}  Some pre-push checks failed! ${CROSS}${NC}"
  echo -e "${RED}  Push aborted.${NC}"
  echo ""
  echo -e "${YELLOW}  Fix the issues above before pushing.${NC}"
  echo -e "${YELLOW}  To bypass this hook (NOT recommended):${NC}"
  echo -e "${YELLOW}    git push --no-verify${NC}"
  echo -e "${BLUE}===========================================${NC}"
  echo ""
  exit 1
fi
